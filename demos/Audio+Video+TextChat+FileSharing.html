<!DOCTYPE html>
<html >
<head>
    <meta charset="UTF-8">
    <title>EmergeTech Video Example</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet prefetch' href='https://s3-us-west-2.amazonaws.com/s.cdpn.io/6035/grid.css'>
    <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Montserrat'>
    <link rel='stylesheet prefetch' href='https://s3-us-west-2.amazonaws.com/s.cdpn.io/6035/icomoon-scrtpxls.css'>
    <link rel="stylesheet" href="/dist/style.css">

    <script src="/dist/polyfill.js" ></script>
    <script src="/dist/cv.js" ></script>

    <script>


    </script>

</head>

<body>
<div class="container">
    <div class="grid_4">
        <section class="box widget locations">
            <div class="avatar">
                <img id="message_image" width="234px" height="234px" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/6035/scrtpxls_location.png"  />
            </div>
            <div class="details">
                <h2 id="message_title">De Westerkerk</h2>
                <p id="message_detail">Prinsengracht 281</p>
                <a href="#" class="btn btn-primary btn-block btn-large">request for more info</a>
            </div>
        </section>
        <section class="box widget calendar">
            <header class="header">
                <h2>Controller</h2>
            </header>
            <article class="days">
                <img id="btn_hidden" src="http://postfiles9.naver.net/MjAxNzAzMjVfMjY4/MDAxNDkwMzc1OTg5OTIz.VMPJPMDP0h-agPYmDKuH2TS4B9VQHQYu2uFj1mcfG5gg.rtMcsh-K6wA2cBmaX3-uonXQft8k-7MpzTgsK95PQRcg.PNG.maverickjin8/button_1.png?type=w2" alt="">

                <img id="btn_top" src="http://postfiles7.naver.net/MjAxNzAzMjVfMTQ2/MDAxNDkwMzc1OTkxMTU5.iP2mJvB5AGi6uT45wVWMFfmznw3hGUeggQk07-MLpjsg.EH_hNRLQ7ghxwWgh2hNKPROaJv-2eMcncvYdRmMRPGgg.PNG.maverickjin8/button_4.png?type=w2" alt="">
                <img id="btn_hidden" src="http://postfiles4.naver.net/MjAxNzAzMjVfMjI2/MDAxNDkwMzc1OTkwNzU1.rj1AnZVdCLte94IZpXbfAsmumvARBsbbtLex46T9Jn0g.h2JL3IlEsBYs5ibhbhT25LzxVpUydlS06mCg27wNiKwg.PNG.maverickjin8/button_3.png?type=w2" alt="">

                <img id="btn_left" src="http://postfiles9.naver.net/MjAxNzAzMjVfMjY4/MDAxNDkwMzc1OTg5OTIz.VMPJPMDP0h-agPYmDKuH2TS4B9VQHQYu2uFj1mcfG5gg.rtMcsh-K6wA2cBmaX3-uonXQft8k-7MpzTgsK95PQRcg.PNG.maverickjin8/button_1.png?type=w2" alt="">
                <img id="btn_center" src="http://postfiles10.naver.net/MjAxNzAzMjVfMTQ1/MDAxNDkwMzc1OTkwMzA0.j8sUhZUyzyiTuK5zhiRreH-Sou9udvL1pl_cKL-qbo8g.Uo_zWvpD7O9J3fbLYlnxTgbhWzVtx0gr8AnTw7tpibgg.PNG.maverickjin8/button_2.png?type=w2" alt="">
                <img id="btn_right" src="http://postfiles9.naver.net/MjAxNzAzMjVfMjY4/MDAxNDkwMzc1OTg5OTIz.VMPJPMDP0h-agPYmDKuH2TS4B9VQHQYu2uFj1mcfG5gg.rtMcsh-K6wA2cBmaX3-uonXQft8k-7MpzTgsK95PQRcg.PNG.maverickjin8/button_1.png?type=w2" alt="">

                <img id="btn_hidden" src="http://postfiles9.naver.net/MjAxNzAzMjVfMjY4/MDAxNDkwMzc1OTg5OTIz.VMPJPMDP0h-agPYmDKuH2TS4B9VQHQYu2uFj1mcfG5gg.rtMcsh-K6wA2cBmaX3-uonXQft8k-7MpzTgsK95PQRcg.PNG.maverickjin8/button_1.png?type=w2" alt="">
                <img id="btn_bottom" src="http://postfiles7.naver.net/MjAxNzAzMjVfMTQ2/MDAxNDkwMzc1OTkxMTU5.iP2mJvB5AGi6uT45wVWMFfmznw3hGUeggQk07-MLpjsg.EH_hNRLQ7ghxwWgh2hNKPROaJv-2eMcncvYdRmMRPGgg.PNG.maverickjin8/button_4.png?type=w2" alt="">
                <img id="btn_hidden" src="http://postfiles9.naver.net/MjAxNzAzMjVfMjY4/MDAxNDkwMzc1OTg5OTIz.VMPJPMDP0h-agPYmDKuH2TS4B9VQHQYu2uFj1mcfG5gg.rtMcsh-K6wA2cBmaX3-uonXQft8k-7MpzTgsK95PQRcg.PNG.maverickjin8/button_1.png?type=w2" alt="">
            </article>
        </section>
    </div>
    <div class="grid_8">
        <nav class="box nav">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon-home"></span><br />
                        <span class="title">Home</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <span class="icon-images"></span><br />
                        <span class="title">Tour</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <span class="icon-bubble"></span><br />
                        <span class="title">Ask</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <span class="icon-cog"></span><br />
                        <span class="title">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>


        <div class="inner_container">
            <div class="grid_8">
                <article class="box post">
                    <div class="image">
                        <div id="chat-container">
                            <div id="file-container"></div>
                            <div class="chat-output"></div>
                        </div>

                        <div id="videos-container"></div>
                        <canvas id="canvas"></canvas>
                        <canvas id="marker" width='100' height='100' style="border:1px dotted grey;"></canvas>
                        <p><button id="saveMarker">save it</button></p>
                    </div>
                    <div class="details">
                        <h2>Amsterdan</h2>
                        <div class="make-center">
                            <input type="text" id="room-id" value="abcdef">
                            <button id="open-room">Open Room</button>
                            <button id="join-room">Join Room</button>
                            <button id="open-or-join-room">Auto Open Or Join Room</button>

                            <br><br>
                            <input type="text" id="input-text-chat" placeholder="Enter Text Chat" disabled>
                            <button id="share-file" disabled>Share File</button>
                            <br><br>
                            <button id="btn-leave-room" disabled>Leave /or close the room</button>

                            <div id="room-urls" style="text-align: center;display: none;background: #F1EDED;margin: 15px -10px;border: 1px solid rgb(189, 189, 189);border-left: 0;border-right: 0;"></div>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
</div>

<script src="/dist/RTCMultiConnection.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/dist/getMediaElement.js"></script>
<script src="/dist/FileBufferReader.js"></script>


<script>
    var scr = document.createElement("script");
    scr.src = "/dist/pupil.js" + "?ts=" + new Date().getTime();
    document.getElementsByTagName("head")[0].appendChild(scr);
</script>

<script>
    var camera, canvas, context, imageData, pixels, detector, marker, markerContext;
    var debugImage, warpImage, homographyImage, video;


    function run_camera() {

        camera = document.getElementsByTagName("video");
        canvas = document.getElementById("canvas");
        marker = document.getElementById("marker");
        markerContext = marker.getContext("2d");
        context = canvas.getContext("2d");

        function drawMarker(id) {
            var mat = AR.Marker.generate(id, 5);
            var cellSize = marker.width / mat.length;
            for (i = 0; i < mat.length; i++) {
                for (j = 0; j < mat[i].length; j++) {
                    markerContext.fillStyle = mat[j][i] == 0 ? "#000" : "#FFF";
                    markerContext.fillRect(i * cellSize, j * cellSize, i * cellSize + cellSize, j * cellSize + cellSize);
                }
            }
        }

        marker.addEventListener("click", function () {
            var id = parseInt(prompt("What marker ID would you like to generate?", ""));
            drawMarker(id);
        });

        drawMarker(0);
        drawMarker(1);
        drawMarker(2);

        document.getElementById('saveMarker').addEventListener("click", function () {
            window.open(marker.toDataURL('image/png'));
        });

        camera.width = 620;
        camera.height = 450;

        canvas.width = parseInt(camera.width);
        canvas.height = parseInt(camera.height);

        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (navigator.getUserMedia) {

            video = camera[0]
            imageData = context.getImageData(0, 0, camera.width, camera.height);
            pixels = [];
            detector = new AR.Detector();

            debugImage = context.createImageData(camera.width, camera.height);
            warpImage = context.createImageData(49, 49);
            homographyImage = new CV.Image();

            requestAnimationFrame(tick);

        }

    }


    // ......................................................
    // .......................UI Code........................
    // ......................................................

    document.getElementById('open-room').onclick = function() {
        disableInputButtons();

        connection.open(document.getElementById('room-id').value, true);
        showRoomURL(connection.sessionid);

//                connection.open(document.getElementById('room-id').value, function() {
//                    showRoomURL(connection.sessionid);
//                    return true;
//                });
    };

    document.getElementById('join-room').onclick = function() {
        disableInputButtons();
        connection.join(document.getElementById('room-id').value);
    };

    document.getElementById('open-or-join-room').onclick = function() {
        disableInputButtons();
        connection.openOrJoin(document.getElementById('room-id').value, function(isRoomExists, roomid) {
            if(!isRoomExists) {
                showRoomURL(roomid);
            }
        });
    };

    document.getElementById('btn-leave-room').onclick = function() {
        this.disabled = true;

        if(connection.isInitiator) {
            // use this method if you did NOT set "autoCloseEntireSession===true"
            // for more info: https://github.com/muaz-khan/RTCMultiConnection#closeentiresession
            connection.closeEntireSession(function() {
                document.querySelector('h1').innerHTML = 'Entire session has been closed.';
            });
        }
        else {
            connection.leave();
        }
    };

    // ......................................................
    // ................FileSharing/TextChat Code.............
    // ......................................................

    document.getElementById('share-file').onclick = function() {
        var fileSelector = new FileSelector();
        fileSelector.selectSingleFile(function(file) {
            connection.send(file);
        });
    };

    document.getElementById('input-text-chat').onkeyup = function(e) {
        if (e.keyCode != 13) return;

        // removing trailing/leading whitespace
        this.value = this.value.replace(/^\s+|\s+$/g, '');
        if (!this.value.length) return;

        connection.send(this.value);
        appendDIV(this.value);
        this.value = '';
    };

    var chatContainer = document.querySelector('.chat-output');

    function appendDIV(event) {
        var div = document.createElement('div');
        div.innerHTML = event.data || event;
        chatContainer.insertBefore(div, chatContainer.firstChild);
        div.tabIndex = 0;
        div.focus();

        document.getElementById('input-text-chat').focus();
    }




    // ......................................................
    // ..................RTCMultiConnection Code.............
    // ......................................................

    var connection = new RTCMultiConnection();

    connection.socketURL = '/';
    connection.socketMessageEvent = 'audio-video-file-chat-demo';
    connection.enableFileSharing = true; // by default, it is "false".

    connection.session = {
        audio: true,
        video: {
            facingMode : { exact: "enviroment"}
        },
        data: true
    };

    connection.sdpConstraints.mandatory = {
        OfferToReceiveAudio: false,
        OfferToReceiveVideo: true
    };

    connection.videosContainer = document.getElementById('videos-container');
    connection.onstream = function(event) {

        if(connection.userid != event.userid) {

            var width = parseInt(connection.videosContainer.clientWidth / 2) - 20;
            var mediaElement = getMediaElement(event.mediaElement, {
                title: event.userid,
                buttons: ['full-screen'],
                width: width,
                showOnMouseEnter: false
            });

            connection.videosContainer.appendChild(mediaElement);

            setTimeout(function () {
                mediaElement.media.play();
            }, 5000);

            mediaElement.id = event.streamid;

            setTimeout(run_camera, 3000);

        }
    };

    connection.onstreamended = function(event) {
        var mediaElement = document.getElementById(event.streamid);
        if(mediaElement) {
            mediaElement.parentNode.removeChild(mediaElement);
        }
    };

    connection.onmessage = appendDIV;
    connection.filesContainer = document.getElementById('file-container');

    connection.onopen = function() {
        document.getElementById('share-file').disabled = false;
        document.getElementById('input-text-chat').disabled = false;
        document.getElementById('btn-leave-room').disabled = false;

        document.querySelector('h2').innerHTML = 'You are connected with: ' + connection.getAllParticipants().join(', ');


    };

    connection.onclose = function() {
        if(connection.getAllParticipants().length) {
            document.querySelector('h1').innerHTML = 'You are still connected with: ' + connection.getAllParticipants().join(', ');
        }
        else {
            document.querySelector('h1').innerHTML = 'Seems session has been closed or all participants left.';
        }
    };

    connection.onEntireSessionClosed = function(event) {
        document.getElementById('share-file').disabled = true;
        document.getElementById('input-text-chat').disabled = true;
        document.getElementById('btn-leave-room').disabled = true;

        document.getElementById('open-or-join-room').disabled = false;
        document.getElementById('open-room').disabled = false;
        document.getElementById('join-room').disabled = false;
        document.getElementById('room-id').disabled = false;

        connection.attachStreams.forEach(function(stream) {
            stream.stop();
        });

        // don't display alert for moderator
        if(connection.userid === event.userid) return;
        document.querySelector('h1').innerHTML = 'Entire session has been closed by the moderator: ' + event.userid;
    };

    connection.onUserIdAlreadyTaken = function(useridAlreadyTaken, yourNewUserId) {
        // seems room is already opened
        connection.join(useridAlreadyTaken);
    };



    function tick(){
        requestAnimationFrame(tick);

        if (video.readyState === video.HAVE_ENOUGH_DATA){
            snapshot();
            var markers = detector.detect(imageData);
            drawCorners(markers);
            drawId(markers);
        }
    }

    function snapshot(){
        context.drawImage(video, 0, 0, camera.width, camera.height);
        imageData = context.getImageData(0, 0, camera.width, camera.height);
    }



    function drawCorners(markers){
        var corners, corner, i, j;

        context.lineWidth = 3;

        for (i = 0; i !== markers.length; ++ i){
            corners = markers[i].corners;



            // begin custom shape
            context.beginPath();

            for (j = 0; j !== corners.length; ++ j){
                corner = corners[j];
                context.moveTo(corner.x, corner.y);
                corner = corners[(j + 1) % corners.length];
                context.lineTo(corner.x, corner.y);
            }


            context.closePath();
            context.lineWidth = 5;
            context.strokeStyle = 'blue';
            context.stroke();


        }
    }

    function drawId(markers){
        var corners, corner, x, y, i, j;

        context.strokeStyle = "blue";
        context.lineWidth = 1;

        for (i = 0; i !== markers.length; ++ i){
            corners = markers[i].corners;

            x = Infinity;
            y = Infinity;

            for (j = 0; j !== corners.length; ++ j){
                corner = corners[j];

                x = Math.min(x, corner.x);
                y = Math.min(y, corner.y);
            }

            var text_message = '';

            switch(markers[i].id){
                case 0:
                    text_message = 'Living Room';
                    document.getElementById('message_title').innerHTML = "Living Room";
                    document.getElementById('message_detail').innerHTML = "Lovely Living Room with everything!";
                    document.getElementById('message_image').setAttribute('src','http://postfiles2.naver.net/MjAxNzAzMjVfNjkg/MDAxNDkwMzkxNjcyMTY5.1EAyDb4Tvm8MrbKNk3_GVuvLGCuxz5VxFe3pvrqJ6QMg.hQw82BwTTxLaK6W65w1L6STDmsAvV4zicvi30qQXsr8g.JPEG.maverickjin8/5d1121840bae6c57_8463-w500-h400-b0-p0--modern-living-room.jpg?type=w2');
                    break;
                case 2:
                    text_message = 'Bathroom';
                    document.getElementById('message_title').innerHTML = "Bath Room";
                    document.getElementById('message_detail').innerHTML = "Lovely Bath Room with everything!";
                    document.getElementById('message_image').setAttribute('src','http://postfiles14.naver.net/MjAxNzAzMjVfNjAg/MDAxNDkwMzkxNjcyNTY4.RH7-SQMhMtO3QC8p0_x1QVeK3-Rb_jM-odlIr4NwmNIg.jaS5CkGpmVxtSAfKAnbP684Q33Ko2oG7U0ZN77VjLAAg.JPEG.maverickjin8/dp15202_4col_All_Bathroom_Vanities.jpeg?type=w2');
                    break;

            }


            console.log("Found marker " + markers[i].id);
            context.font = "30px Arial";
            context.shadowColor = "#FFF";
            var width = context.measureText(text_message).width + blur * 2;
            context.shadowOffsetX = width;
            context.shadowOffsetY = 0;
            context.shadowBlur = 10;
            context.fillText(text_message, x, y)

        }


    }



    function disableInputButtons() {
        document.getElementById('open-or-join-room').disabled = true;
        document.getElementById('open-room').disabled = true;
        document.getElementById('join-room').disabled = true;
        document.getElementById('room-id').disabled = true;
    }

    // ......................................................
    // ......................Handling Room-ID................
    // ......................................................

    function showRoomURL(roomid) {
        var roomHashURL = '#' + roomid;
        var roomQueryStringURL = '?roomid=' + roomid;

        var html = '<h2>Unique URL for your room:</h2><br>';

        html += 'Hash URL: <a href="' + roomHashURL + '" target="_blank">' + roomHashURL + '</a>';
        html += '<br>';
        html += 'QueryString URL: <a href="' + roomQueryStringURL + '" target="_blank">' + roomQueryStringURL + '</a>';

        var roomURLsDiv = document.getElementById('room-urls');
        roomURLsDiv.innerHTML = html;

        roomURLsDiv.style.display = 'block';
    }

    (function() {
        var params = {},
            r = /([^&=]+)=?([^&]*)/g;

        function d(s) {
            return decodeURIComponent(s.replace(/\+/g, ' '));
        }
        var match, search = window.location.search;
        while (match = r.exec(search.substring(1)))
            params[d(match[1])] = d(match[2]);
        window.params = params;
    })();

    var roomid = '';
    if (localStorage.getItem(connection.socketMessageEvent)) {
        roomid = localStorage.getItem(connection.socketMessageEvent);
    } else {
        roomid = connection.token();
    }
    document.getElementById('room-id').value = roomid;
    document.getElementById('room-id').onkeyup = function() {
        localStorage.setItem(connection.socketMessageEvent, this.value);
    };

    var hashString = location.hash.replace('#', '');
    if(hashString.length && hashString.indexOf('comment-') == 0) {
        hashString = '';
    }

    var roomid = params.roomid;
    if(!roomid && hashString.length) {
        roomid = hashString;
    }

    if(roomid && roomid.length) {
        document.getElementById('room-id').value = roomid;
        localStorage.setItem(connection.socketMessageEvent, roomid);

        // auto-join-room
        (function reCheckRoomPresence() {
            connection.checkPresence(roomid, function(isRoomExists) {
                if(isRoomExists) {
                    connection.join(roomid);
                    return;
                }

                setTimeout(reCheckRoomPresence, 5000);
            });
        })();

        disableInputButtons();
    }

</script>

</body>
</html>

